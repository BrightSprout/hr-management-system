
(function(global) {
  const employees = {};
  const departments = {};
  const employeesAttendances = {};
  const employeesLeaves = {};

  async function fetchJSON(url) {
    const response = await fetch(url);
    return await response.json();
  }

  function getInputDateWithNoTime(date) {
    const newDate = new Date(date);
    newDate.setHours(0,0,0,0);
    return newDate;
  }

  function formatLocalDate(date) {
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, "0");
    const d = String(date.getDate()).padStart(2, "0");
    return `${y}-${m}-${d}`;
  }

  function memoizeFn(fn) {
    const cache = new Map();
    return (data) => {
      if (cache.has(data)) 
        return cache.get(data);
      const output = fn(data);
      cache.set(data,output);
      return output;
    }
  }

  async function getBase64ImageFromUrl(url) {
    try {
        const response = await fetch(url);
        const blob = await response.blob();
        return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
        });
    } catch (error) {
        console.error('try image:', error);
        return null;
    }
  }

  async function generatePDFReport(data, options = {}) {
    const {
        title = "Leave and Attendance Report",
        leftLogoUrl = "public/assets/images/logo-1.png",
        rightLogoUrl = "public/assets/images/logo-2.png",
        filename = "Leave_Attendance_Report.pdf"
    } = options;


    const leftLogo = await getBase64ImageFromUrl(leftLogoUrl);
    const rightLogo = await getBase64ImageFromUrl(rightLogoUrl);

    const docDefinition = {
        pageSize: 'A4',
        pageMargins: [40, 60, 40, 60],
        
        footer: function (currentPage, pageCount) {
        return {
            columns: [
            {
                text: "Generated by Barangay Mamatid HR System",
                fontSize: 8,
                color: "#7f8c8d",
                alignment: "left",
            },
            {
                text: `Page ${currentPage} of ${pageCount}`,
                fontSize: 8,
                color: "#7f8c8d",
                alignment: "right",
            },
            ],
            margin: [40, 10, 40, 0],
        };
        },
        
        content: [
        {
            columns: [
            leftLogo ? { image: leftLogo, width: 60, alignment: "left" } : { text: '', width: 60 },
            {
                stack: [
                { text: "BARANGAY MAMATID", style: "mainHeader" },
                { text: "HR Management System", style: "subHeader" },
                { text: title, style: "reportTitle" },
                ],
                alignment: "center",
                width: "*",
            },
            rightLogo ? { image: rightLogo, width: 60, alignment: "right" } : { text: '', width: 60 },
            ],
            margin: [0, 0, 0, 20],
        },

        { text: "Most Common Absent Days per Week", style: "tableHeader" },
        {
            table: {
            headerRows: 1,
            widths: ['*', '*'],
            body: [
                [
                { text: 'Day', style: 'tableHeaderCell' },
                { text: 'Absences', style: 'tableHeaderCell' }
                ],
                ...data.absentDays.map(item => [item.day, item.absences.toString()])
            ]
            },
            layout: 'lightHorizontalLines',
            margin: [0, 5, 0, 15]
        },

        { text: "Monthly Leave Request Trends", style: "tableHeader" },
        {
            table: {
            headerRows: 1,
            widths: ['*', '*'],
            body: [
                [
                { text: 'Month', style: 'tableHeaderCell' },
                { text: 'Leaves Taken', style: 'tableHeaderCell' }
                ],
                ...data.monthlyLeaves.map(item => [item.month, item.leaves.toString()])
            ]
            },
            layout: 'lightHorizontalLines',
            margin: [0, 5, 0, 15]
        },

        {
            stack: [
            { text: "Performance Score", style: "tableHeader" },
            { 
                text: `${data.performanceScore}%`, 
                style: "performanceScore",
                margin: [0, 5, 0, 15]
            }
            ]
        },

        { text: "Leave Requests Status", style: "tableHeader" },
        {
            table: {
            headerRows: 1,
            widths: ['*', '*'],
            body: [
                [
                { text: 'Status', style: 'tableHeaderCell' },
                { text: 'Total', style: 'tableHeaderCell' }
                ],
                ...data.leaveStatus.map(item => [item.status, item.total.toString()])
            ]
            },
            layout: 'lightHorizontalLines',
            margin: [0, 5, 0, 15]
        },

        { text: "Absence Without Leave (AWOL)", style: "tableHeader" },
        {
            table: {
            headerRows: 1,
            widths: ['*', '*'],
            body: [
                [
                { text: 'Type', style: 'tableHeaderCell' },
                { text: 'Total', style: 'tableHeaderCell' }
                ],
                ...data.awolData.map(item => [item.type, item.total.toString()])
            ]
            },
            layout: 'lightHorizontalLines',
            margin: [0, 5, 0, 15]
        },

        { text: '', pageBreak: 'before' },


        { text: "Detailed Leave Records", style: "tableHeader" },
        {
            table: {
            headerRows: 1,
            widths: ['auto', 'auto', 'auto', '*', 'auto', 'auto', 'auto'],
            body: [
                [
                { text: 'Name', style: 'tableHeaderCell' },
                { text: 'Date Leave', style: 'tableHeaderCell' },
                { text: 'Date Returning', style: 'tableHeaderCell' },
                { text: 'Description', style: 'tableHeaderCell' },
                { text: 'Type of Leave', style: 'tableHeaderCell' },
                { text: 'Approved By', style: 'tableHeaderCell' },
                { text: 'Status', style: 'tableHeaderCell' }
                ],
                ...data.detailedLeaves.map(item => [
                  item.name,
                  formatLocalDate(new Date(item.start_date * 1000)),
                  formatLocalDate(new Date(item.end_date * 1000)),
                  item.reason,
                  item.type,
                  item.approvedBy ?? "Admin",
                  item.status
                ])
            ]
            },
            layout: 'lightHorizontalLines',
            margin: [0, 5, 0, 15]
        }
        ],

        styles: {
        mainHeader: { fontSize: 18, bold: true, color: '#1e40af', margin: [0, 0, 0, 5] },
        subHeader: { fontSize: 12, color: '#64748b', margin: [0, 0, 0, 3] },
        reportTitle: { fontSize: 14, bold: true, color: '#334155', margin: [0, 5, 0, 0] },
        tableHeader: { fontSize: 13, bold: true, color: '#1e293b', margin: [0, 10, 0, 5]},
        tableHeaderCell: { fillColor: '#e2e8f0', color: '#1e293b', bold: true, fontSize: 10, margin: [5, 5, 5, 5] },
        performanceScore: { fontSize: 24, bold: true, color: '#059669', alignment: 'center' }
        },

        defaultStyle: { fontSize: 9, color: '#334155'}
    };


    pdfMake.createPdf(docDefinition).download(filename);
  }

  const getRequestLeaveTotalPerStatus = memoizeFn((leaves) => {
    const result = {pending: 0, approved: 0, rejected: 0};
    for (let leave of Object.values(leaves))
      result[leave.status.toLowerCase()]++;
    return result;
  });

  function displayAbsentsPerDay(absents) {
    const attendanceCtx = document.getElementById('attendanceChart');
    new Chart(attendanceCtx, {
      type: 'bar',
      data: {
        labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', "Sat", "Sun"],
        datasets: [{
          label: 'Most No. of Absent',
          data: absents,
          backgroundColor: '#3b82f6'
        }]
      },
      options: { responsive: true, plugins: { legend: { display: false } } }
    });   
  }

  function displayMonthlyLeaves(monthlyLeaves) {
    const leaveCtx = document.getElementById('leaveChart');
      new Chart(leaveCtx, {
        type: 'line',
        data: {
          labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', "June", "July", "Aug", "Sept", "Oct","Nov", "Dec"],
          datasets: [{
            label: 'Leaves Taken',
            data: monthlyLeaves,
            borderColor: '#10b981',
            backgroundColor: 'rgba(16, 185, 129, 0.2)',
            fill: true
          }]
        },
        options: { responsive: true }
      });
  }

  function displayPerformanceScore(performanceScore) {
    const performanceCtx = document.getElementById('performanceChart');
      new Chart(performanceCtx, {
          type: 'doughnut',
          data: {
              labels: ['Present %', 'Absent %'],
              datasets: [{
                  data: [performanceScore.toFixed(2), (100 - performanceScore).toFixed(2)],
                  backgroundColor: ['#f59e0b', '#e5e7eb']
              }]
          },
          options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
      });
  }

  function displayEmployeesLeaves({leaveRequestsTotalPerStatus}) {
    document.querySelector("#pending-leave-total").textContent = leaveRequestsTotalPerStatus.pending;
    document.querySelector("#approved-leave-total").textContent = leaveRequestsTotalPerStatus.approved;
    document.querySelector("#rejected-leave-total").textContent = leaveRequestsTotalPerStatus.rejected;
  }

  function displayAWOLs({awolsTotalPerType}) {
    document.querySelector("#awol-total").innerHTML = awolsTotalPerType.awol; 
    document.querySelector("#unexcused-absence-total").innerHTML = awolsTotalPerType.unexcused; 
    document.querySelector("#investigate-absence-total").innerHTML = awolsTotalPerType.investigate; 
  }

  function displayLeaveRecords({employees, leaves}) {
    const StatusColor = {PENDING: "yellow", APPROVED: "green", REJECTED: "red"};
    document.querySelector("#display-leave-records").innerHTML = Object.values(leaves).map(leave => {
      const  {first_name,middle_name,last_name} = employees[leave.employee_id];
      const statusColor = StatusColor[leave.status];
      return `
        <tr class="hover:bg-gray-50">
          <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${first_name} ${middle_name} ${last_name}</td>
          <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${formatLocalDate(new Date(leave.start_date * 1000))}</td>
          <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${formatLocalDate(new Date(leave.end_date * 1000))}</td>
          <td class="px-4 py-3 text-sm text-gray-500">${leave.reason}</td>
          <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${leave.type[0] + leave.type.slice(1).toLowerCase()} Leave</td>
          <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">Secretary</td>
          <td class="px-4 py-3 whitespace-nowrap">
            <span
              class="px-2 py-1 text-xs font-semibold rounded-full bg-${statusColor}-100 text-${statusColor}-800">${leave.status[0] + leave.status.slice(1).toLowerCase()}</span>
          </td>
        </tr>`;
    }).join("\n");
  }

  function getTotalAttendancePerDay({employees, departments, attendancesList, leavesList}) {
    const absentsPerDay = [0,0,0,0,0,0,0]; // included the weekends
    const presentsPerDay = [0,0,0,0,0,0,0]; 
    const leavesPerDay = [0,0,0,0,0,0,0]; 
    const allAWOL = {};

    function getAWOLType(totalAbsent) {
      return totalAbsent > 6 ? "awol" :
        totalAbsent > 2 ? "investigate" : "unexcused"; 
    }

    for (let employee of Object.values(employees)) {
      const department = departments[employee.jobs.department_id];
      const attendances = attendancesList[employee.biometric_id];
      const leaves = leavesList[employee.id] ?? [];
      const employeeAWOL = {
        awol: 0,
        investigate: 0,
        unexcused: 0,
      };

      const startDate = new Date(employee.jobs.appointment_date * 1000);
      const endDate = new Date();
      endDate.setDate(endDate.getDate() + 1); // we end the loop until the next day after the end date to include the end date.
      let startLocalDate;
      let absentCount = 0;
      while ((startLocalDate = formatLocalDate(startDate)) !== formatLocalDate(endDate)) {
         if (startDate.getTime() > endDate.getTime())
           break;
         if (department.dayoffs.includes(startDate.getDay())) {
           startDate.setDate(startDate.getDate() + 1);  
           continue;
         }
         const attendance = attendances?.[startLocalDate];
         const onLeave = leaves.includes(getInputDateWithNoTime(startDate.getTime()).getTime()/1000);
         const dayOfTheWeek = startDate.getDay();
         if (onLeave)
           leavesPerDay[dayOfTheWeek]++;  
         else if (attendance)
           presentsPerDay[dayOfTheWeek]++;
         else
           absentsPerDay[dayOfTheWeek]++;

         (onLeave || attendance) ? (absentCount > 0 && employeeAWOL[getAWOLType(absentCount)]++,absentCount=0) : absentCount++;
        startDate.setDate(startDate.getDate() + 1);  
      }
      if (absentCount > 0)
        employeeAWOL[getAWOLType(absentCount)]++;
      allAWOL[employee.id] = employeeAWOL;
    }
    return {
      absentsPerDay,
      presentsPerDay,
      leavesPerDay,
      allAWOL,
    };
  }

  function getMonthlyLeaves({leaves}) {
    const monthlyLeaves = [0,0,0,0,0,0,0,0,0,0,0,0];
    for (let leave of Object.values(leaves)) {
      if (leave.status != "APPROVED")
        continue;
      if (leave.start_date > leave.end_date) // for preventing errors
        continue;
      const startDate = new Date(leave.start_date * 1000);
      startDate.setDate(1); // preventing day overflow with february, if the date in start date is 31.
      const endDate = new Date(leave.end_date * 1000);
      while(startDate.getMonth() !== endDate.getMonth() || startDate.getFullYear() !== endDate.getFullYear()) {
        monthlyLeaves[startDate.getMonth()]++;
        startDate.setMonth(startDate.getMonth() + 1);
      }
      monthlyLeaves[endDate.getMonth()]++; // include the end date month
    }
    return monthlyLeaves;
  }

  function displayEmployeeDropDown({employees}) {
    document.querySelector("#employeeDropdown").innerHTML = `
      <option value="">All Employees</option>
    ` + Object.values(employees).map(employee => `<option value="${employee.id}">${employee.first_name} ${employee.middle_name} ${employee.last_name}</option>`).join("\n");
  }

  async function init() {
    const employeesList = await fetchJSON("api/list-employees");    
    const departmentsList = await fetchJSON("api/list-departments");    
    const attendancesList = await fetchJSON("api/list-attendances");    
    const leavesList = await fetchJSON("api/list-leaves");    
    
    const employeesAttendancesDict = {};
    const employeeLeavesDict = {};
    const employeeLeavesDictUNIX = {};
    for (let attendance of Object.values(attendancesList)) {
      if (employeesAttendancesDict[attendance.biometric_id])
        employeesAttendancesDict[attendance.biometric_id][attendance.attended_date] = attendance;
      else 
        employeesAttendancesDict[attendance.biometric_id] = {
          [attendance.attended_date]: attendance
        };
    }

    for (let leave of Object.values(leavesList)) {
      if (employeeLeavesDict[leave.employee_id])
         employeeLeavesDict[leave.employee_id][leave.id] = leave;
      else 
         employeeLeavesDict[leave.employee_id] = {[leave.id]: leave};
      if (leave.status != "APPROVED")
        continue;
      const dates = [];
      const endDate = getInputDateWithNoTime(leave.end_date*1000).getTime()/1000;
      // add a day from start_date up to end_date
      for (let i = getInputDateWithNoTime(leave.start_date * 1000).getTime()/1000; i < endDate; i+=86400)
        dates.push(i);
      dates.push(endDate);
      if (employeeLeavesDictUNIX[leave.employee_id])
         employeeLeavesDictUNIX[leave.employee_id] = [...(new Set([...employeeLeavesDictUNIX[leave.employee_id],...dates]))];
      else 
         employeeLeavesDictUNIX[leave.employee_id] = dates;
    }
    const {absentsPerDay, leavesPerDay, presentsPerDay, allAWOL} = getTotalAttendancePerDay({
      employees: employeesList,
      departments: departmentsList,
      attendancesList: employeesAttendancesDict,
      leavesList: employeeLeavesDictUNIX,
    });
    const allAWOLTotal = Object.values(allAWOL).reduce((all, next) => {
      all.awol += next.awol;
      all.investigate += next.investigate;
      all.unexcused += next.unexcused;
      return all;
    }, {awol: 0,investigate: 0, unexcused: 0});
    displayAbsentsPerDay(absentsPerDay);
    const monthlyLeaves = getMonthlyLeaves({leaves: leavesList});
    displayMonthlyLeaves(monthlyLeaves);
    const totalPresents = presentsPerDay.reduce((a,b) => a+b);
    const totalWorkingDays = totalPresents + absentsPerDay.reduce((a,b) => a+b) + leavesPerDay.reduce((a,b) => a+b);
    const performanceScore =  totalPresents / (Object.values(employeesList).length * totalWorkingDays) * 100;
    displayPerformanceScore(performanceScore);
    displayEmployeeDropDown({employees: employeesList});
    displayEmployeesLeaves({leaveRequestsTotalPerStatus: getRequestLeaveTotalPerStatus(leavesList)});
    displayAWOLs({awolsTotalPerType: allAWOLTotal});
    displayLeaveRecords({employees: employeesList, leaves: leavesList});
    document.querySelector("#employeeDropdown").addEventListener("change", function() {
      const id = this.value;
      let leaves = leavesList;
      let awols = allAWOLTotal;
      if (id) {
        leaves = employeeLeavesDict[id] ?? {};
        awols = allAWOL[id]
      }
      displayEmployeesLeaves({leaveRequestsTotalPerStatus: getRequestLeaveTotalPerStatus(leaves)});
      displayAWOLs({awolsTotalPerType: awols});
      displayLeaveRecords({employees: employeesList, leaves});
    });
    const today = new Date();
    document.querySelector("#today-date-txt").textContent = ["January","February","March","April","May","June","July","August","September","October","November","December"][today.getMonth()] + " " + today.getFullYear();

    document.getElementById('generateMonthlyReport')?.addEventListener('click', async () => {
      const today = new Date();
      const leaveRequestsTotalPerStatus = getRequestLeaveTotalPerStatus(leavesList);
      const monthlyData = {
        absentDays: [
          { day: 'Monday', absences: absentsPerDay[1] },
          { day: 'Tuesday', absences: absentsPerDay[2] },
          { day: 'Wednesday', absences: absentsPerDay[3] },
          { day: 'Thursday', absences: absentsPerDay[4] },
          { day: 'Friday', absences: absentsPerDay[5] },
          { day: 'Saturday', absences: absentsPerDay[6] },
          { day: 'Sunday', absences: absentsPerDay[0] },
        ],
        monthlyLeaves: [
          { month: 'January', leaves: monthlyLeaves[0] },
          { month: 'February', leaves: monthlyLeaves[1] },
          { month: 'March', leaves: monthlyLeaves[2] },
          { month: 'April', leaves: monthlyLeaves[3] },
          { month: 'May', leaves: monthlyLeaves[4] },
          { month: 'June', leaves: monthlyLeaves[5] },
          { month: 'July', leaves: monthlyLeaves[6] },
          { month: 'August', leaves: monthlyLeaves[7] },
          { month: 'September', leaves: monthlyLeaves[8] },
          { month: 'October', leaves: monthlyLeaves[9] },
          { month: 'November', leaves: monthlyLeaves[10] },
          { month: 'December', leaves: monthlyLeaves[11] }
        ],
        performanceScore: performanceScore.toFixed(2),
        leaveStatus: [
          { status: 'Approved', total: leaveRequestsTotalPerStatus.approved },
          { status: 'Pending', total: leaveRequestsTotalPerStatus.pending },
          { status: 'Rejected', total: leaveRequestsTotalPerStatus.rejected }
        ],
        awolData: [
          { type: 'Unexcused Absence', total: allAWOLTotal.unexcused },
          { type: 'No Call No Show', total: allAWOLTotal.awol },
          { type: 'Extended Absence', total: allAWOLTotal.investigate }
        ],
        detailedLeaves: Object.values(leavesList).map(leave => {
          const {first_name,middle_name,last_name} = employeesList[leave.employee_id]; 
          return {...leave, name: `${first_name} ${middle_name} ${last_name}`};
        })
      };

      await generatePDFReport(monthlyData, {
        title: "Monthly Leave and Attendance Report",
        filename: `Monthly_Report_${today.getFullYear()}_${today.getMonth()}_${today.getDate()}.pdf`
      });
    });
  }
  init();
})(window);
