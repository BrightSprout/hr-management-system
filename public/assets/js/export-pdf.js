(function (global){

  async function fetchJSON(url) {
    const response = await fetch(url);
    return await response.json();
  }

  function formatTime(seconds) {
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);

    const hour12 = hours % 12 || 12;
    const ampm = hours >= 12 ? "PM" : "AM";

    return `${hour12.toString().padStart(2, "0")}:${minutes
      .toString()
      .padStart(2, "0")} ${ampm}`;
  }

  function formatLocalDate(date) {
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, "0");
    const d = String(date.getDate()).padStart(2, "0");
    return `${y}-${m}-${d}`;
  }

  function formatStringToNormal(str) {
    return str ? str.split("_").map(word => word[0] + word.slice(1).toLowerCase()).join(" "): "NULL";
  }
    
async function getBase64ImageFromUrl(url) {
  const response = await fetch(url);
  const blob = await response.blob();
  
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onloadend = () => resolve(reader.result); // reader.result is Base64 string
    reader.onerror = reject;
    reader.readAsDataURL(blob);
  });
}

async function generatePDF({ title, reportInfo, tableHeaders, tableData, fileName }) {
  const leftLogo = await getBase64ImageFromUrl("public/assets/images/logo-1.png");
  const rightLogo = await getBase64ImageFromUrl("public/assets/images/logo-2.png");

  const docDefinition = {
    content: [

      {
        columns: [
          { image: leftLogo, width: 60, alignment: "left" },
          {
            stack: [
              { text: "BARANGAY MAMATID", style: "mainHeader" },
              { text: "HR Management System", style: "subHeader" },
              { text: title, style: "reportTitle" },
            ],
            alignment: "center",
            width: "*",
          },
          { image: rightLogo, width: 60, alignment: "right" },
        ],
        margin: [0, 0, 0, 20],
      },

      {
        canvas: [
          {
            type: "line",
            x1: 0,
            y1: 0,
            x2: 515,
            y2: 0,
            lineWidth: 2,
            lineColor: "#34495e",
          },
        ],
        margin: [0, 10, 0, 15],
      },

      { text: "REPORT INFORMATION", style: "sectionTitle", margin: [0, 0, 0, 10] },
      {
        table: {
          widths: [120, "*", 120, "*"],
          body: reportInfo,
        },
        layout: "noBordersCustom",
        margin: [0, 0, 0, 25],
      },

      { text: title.toUpperCase(), style: "sectionTitle", margin: [0, 0, 0, 10] },
      {
        table: {
          headerRows: 1,
          widths: tableHeaders.map(() => "*"),
          body: [
            tableHeaders.map((h) => ({ text: h, style: "tableHeader" })),
            ...tableData.map((row) =>
              row.map((val) => ({ text: val, style: "tableCellCenter" }))
            ),
          ],
        },
        layout: "tableLayoutCustom",
        margin: [0, 0, 0, 25],
      },
    ],

    styles: {
      mainHeader: { fontSize: 20, bold: true, color: "#2c3e50" },
      subHeader: { fontSize: 14, color: "#34495e", margin: [0, 2, 0, 2] },
      reportTitle: { fontSize: 11, italics: true, color: "#7f8c8d" },
      sectionTitle: { fontSize: 12, bold: true, color: "#2c3e50" },
      infoLabel: { fontSize: 10, bold: true, color: "#34495e" },
      infoValue: { fontSize: 10, color: "#2c3e50" },
      tableHeader: { bold: true, fontSize: 10, color: "#2c3e50", alignment: "center" },
      tableCellCenter: { fontSize: 10, color: "#2c3e50", alignment: "center" },
    },

    footer: function (currentPage, pageCount) {
      return {
        columns: [
          {
            text: "Generated by Barangay Mamatid HR System",
            fontSize: 8,
            color: "#7f8c8d",
            alignment: "left",
          },
          {
            text: `Page ${currentPage} of ${pageCount}`,
            fontSize: 8,
            color: "#7f8c8d",
            alignment: "right",
          },
        ],
        margin: [40, 10, 40, 0],
      };
    },

    pageMargins: [40, 60, 40, 80],

    layout: {
      noBordersCustom: {
        hLineWidth: () => 0,
        vLineWidth: () => 0,
        paddingLeft: () => 0,
        paddingRight: () => 0,
        paddingTop: () => 2,
        paddingBottom: () => 2,
      },
      tableLayoutCustom: {
        fillColor: function (rowIndex) {
          return rowIndex === 0
            ? "#f8f9fa"
            : rowIndex % 2 === 0
            ? "#ffffff"
            : "#fafbfc";
        },
        hLineWidth: function (i, node) {
          return i === 0 || i === 1 || i === node.table.body.length ? 1 : 0.5;
        },
        vLineWidth: () => 0.5,
        hLineColor: (i, node) =>
          i === 0 || i === 1 || i === node.table.body.length ? "#34495e" : "#dee2e6",
        vLineColor: () => "#dee2e6",
      },
    },
  };

  pdfMake
    .createPdf(docDefinition)
    .download(`${fileName}_${new Date().toISOString().slice(0, 10)}.pdf`);
}

  function displayAttendanceRecords({attendances}) {
    if (!document.querySelector("#attendance-records"))
      return;
    document.querySelector("#attendance-records").innerHTML = Object.values(attendances).map(attendance => {
      const {first_name,middle_name,last_name,position} = attendance.employee;
      return `
        <tr class="hover:bg-gray-50">
          <td class="px-6 py-4 font-medium text-gray-900">${first_name} ${middle_name} ${last_name}</td>
          <td class="px-6 py-4 text-gray-700">${formatStringToNormal(position)}</td>
          <td class="px-6 py-4 text-green-600">${formatTime(attendance.clock_in)}</td>
          <td class="px-6 py-4 text-red-600">${attendance.clock_out ? formatTime(attendance.clock_out) : "NULL"}</td>
        </tr>
      `;
    }).join("\n");
  }

  async function init() {
    const employees = await fetchJSON("api/list-employees");
    const departments = await fetchJSON("api/list-departments");
    const attendances = await fetchJSON("api/list-today-attendances");

    const employeesAttendancesDict = {};

    const today = new Date();
    const todayString = today.toLocaleDateString("en-US", {year:"numeric",month:"long",day:"numeric"});
    let totalPresent = 0;
    let totalAbsent = 0;

    for (let attendance of Object.values(attendances)) {
      if (employeesAttendancesDict[attendance.biometric_id])
        employeesAttendancesDict[attendance.biometric_id][attendance.attended_date] = attendance;
      else 
        employeesAttendancesDict[attendance.biometric_id] = {
          [attendance.attended_date]: attendance
        };
    }

    for (let employee of Object.values(employees)) {
      const department = departments[employee.jobs.department_id];  
      if (department.dayoffs.includes(today.getDay())) 
        continue;
      if (employeesAttendancesDict[employee.biometric_id]?.[formatLocalDate(today)])
        totalPresent++;
      else
        totalAbsent++;
    }

    displayAttendanceRecords({attendances});
    if (document.querySelector("#today-date"))
      document.querySelector("#today-date").innerHTML = todayString;
    if (document.querySelector(".today-summary-btn")) {
      document.querySelector(".today-summary-btn").addEventListener("click", async () => {
        await generatePDF({
          title: "Today's Attendance Summary",
          reportInfo: [
            ["Date", todayString],
            ["Total Present", totalPresent],
            ["Total Absent", totalAbsent],
          ],
          tableHeaders: ["Name", "Role","Time in", "Time out"],
          tableData: Object.values(attendances).map(attendance => {
            const {first_name, middle_name, last_name, position} = attendance.employee;
            return [`${first_name} ${middle_name} ${last_name}`, formatStringToNormal(position), formatTime(attendance.clock_in), formatTime(attendance.clock_out)];
          }),
          fileName: "attendance_summary",
        });
      });
    }
  }

  init();
}(window));
